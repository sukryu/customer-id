# TasteSync Architecture Overview

이 문서는 TasteSync 플랫폼의 전체 아키텍처를 상위 수준에서 설명합니다. TasteSync는 소상공인 실시간 고객 경험(CX) 최적화 플랫폼으로, 2027년 v1.0 출시 시 500~1,000 사용자(식당 중심)를 목표로 하며, 2040년 1,000만 사용자와 글로벌 점유율 10%를 달성합니다. 초저지연(1초 내), 확장성, 소상공인 배려를 위해 Go, C++, Python 기반의 마이크로서비스 아키텍처를 채택하며, HTTPS ↔ gRPC 변환, 이벤트 드리븐 설계를 구현합니다.

---

## 1. 아키텍처 목표

### 1.1 주요 목표
- **초저지연**: 비콘 감지부터 응답까지 1초 내 처리.
- **확장성**: 초기 소규모(500 사용자)에서 글로벌(1,000만 사용자)까지 지원.
- **소상공인 배려**: 비공개 만족 %, 운영 분석, 피드백 관리 제공.
- **안정성**: 99.9% 가동률, 장애 복구 5분 내(RTO).
- **유연성**: RESTful API 추가 가능성 대비.

### 1.2 설계 원칙
- **DDD**: 도메인 중심 설계로 비즈니스 로직 명확화.
- **헥사고날**: 외부 시스템 격리로 유연성 확보.
- **이벤트 드리븐**: 비동기 이벤트 처리로 응답성 향상.

---

## 2. 시스템 구조

### 2.1 전체 아키텍처 다이어그램
```
+-------------------+       +-------------------+
|   Mobile/POS App  | <---> |   Website/Admin   |  (HTTPS)
+-------------------+       +-------------------+
           ↓                        ↓
+-------------------+       +-------------------+
|   Envoy API GW    | <---> |   Envoy API GW    |  (HTTPS ↔ gRPC)
+-------------------+       +-------------------+
           ↓                        ↓
+-------------------+       +-------------------+
| customer-id (gRPC)| <---> | Other Services    |  (gRPC)
+-------------------+       +-------------------+
           ↓                        ↓
+-------------------+       +-------------------+
| Redis (Cache)     |       | Kafka/NATS (MQ)   |  (Event-Driven)
+-------------------+       +-------------------+
           ↓                        ↓
+-------------------+       +-------------------+
| PostgreSQL/Dynamo |       | S3 (Logs)         |
+-------------------+       +-------------------+
           ↓
+-------------------+
| Prometheus (Monit)|
+-------------------+
```

### 2.2 컴포넌트 설명
- **클라이언트**:
  - **모바일/패드 앱**: 소비자용, 비콘 감지 및 요청.
  - **POS 앱**: 직원용, 실시간 추천/알림.
  - **홈페이지/관리 대시보드**: 정보 제공 및 운영 분석.
- **Envoy API Gateway**: HTTPS 입력 수신, gRPC로 변환, 로드 밸런싱.
- **마이크로서비스**:
  - `customer-id`: 고객 식별 (Go/Fiber/gRPC).
  - 기타: 추천, 알림, 피드백, 지도, 분석.
- **메시지 큐**: Kafka (이벤트 스트리밍), NATS (실시간 알림).
- **데이터베이스**: 
  - Redis: 초고속 캐싱 (TTL 1시간).
  - PostgreSQL: 구조화 데이터.
  - DynamoDB: 트랜잭션/분석.
- **스토리지**: S3 (로그 저장).
- **모니터링**: Prometheus (메트릭 수집).

---

## 3. 데이터 흐름

### 3.1 고객 식별 프로세스
1. **클라이언트 요청**: 모바일 앱에서 비콘 감지 → HTTPS 요청 (`POST https://api.tastesync.com/identify`).
2. **API 게이트웨이**: Envoy가 HTTPS를 gRPC로 변환 → `customer-id`의 `IdentifyCustomer` 호출.
3. **고객 식별**: `customer-id`가 Redis 캐시 확인 → PostgreSQL 조회 → 고객 ID/위치 식별.
4. **이벤트 발행**: `CustomerIdentified` 이벤트를 Kafka로 발행.
5. **응답**: gRPC 응답 → Envoy에서 HTTPS로 변환 → 클라이언트에 반환(<1초).
6. **이벤트 처리**: 추천/알림 서비스가 Kafka에서 이벤트 구독 → 비동기 처리.

### 3.2 운영 분석 요청
1. **홈페이지 요청**: HTTPS로 `analytics` 호출.
2. **API 게이트웨이**: Envoy → gRPC 변환 → `analytics` 서비스.
3. **분석**: DynamoDB/Kinesis 데이터 조회 → 결과 반환.
4. **응답**: gRPC → HTTPS → 대시보드 렌더링.

---

## 4. 주요 설계 세부사항

### 4.1 통신
- **외부**: HTTPS (TLS 1.3)로 클라이언트와 통신, Envoy에서 gRPC로 변환.
- **내부**: gRPC (TLS 암호화)로 마이크로서비스 간 통신.
- **유연성**: RESTful API 추가 시 Envoy에 별도 라우팅 설정 가능.

### 4.2 이벤트 처리
- **Kafka**: `CustomerIdentified` 등 대규모 이벤트 저장/재처리.
- **NATS**: 실시간 알림(예: "고객 A 입장") 초저지연 처리.
- **통합**: Kafka로 이벤트 내구성, NATS로 응답성 확보.

### 4.3 데이터 관리
- **캐싱**: Redis로 비콘 데이터 캐싱(TTL 1시간).
- **영구 저장**: PostgreSQL(고객 데이터), DynamoDB(분석 데이터).
- **로그**: S3에 암호화 저장, 주기적 백업.

### 4.4 보안
- **인증**: JWT (RSA 2048비트)로 서비스 간/외부 요청 인증.
- **암호화**: AES-256으로 민감 데이터 보호.
- **모니터링**: Prometheus로 응답 시간/오류율 추적.

---

## 5. 마이크로서비스 구성

### 5.1 customer-id
- **역할**: 고객 식별 및 위치 파악.
- **기술**: Go 1.23, Fiber, gRPC.
- **도메인**: `Customer`, `Beacon`.

### 5.2 기타 서비스 (간략)
- **recommendation**: Python, 추천 생성.
- **notification**: Go, 실시간 알림.
- **feedback**: Python, 피드백 관리.
- **map**: Go, 지도 표시.
- **analytics**: C++, 데이터 분석.

---

## 6. 배포 및 운영

### 6.1 배포 환경
- **클라우드**: AWS ECS/EKS, Graviton 인스턴스 사용.
- **컨테이너**: Docker로 서비스별 패키징.
- **오케스트레이션**: Kubernetes로 스케일링/복구.

### 6.2 모니터링
- **도구**: Prometheus, Grafana.
- **메트릭**: 응답 시간, 요청 실패율, 서비스 상태.

---

## 7. 결론
TasteSync 아키텍처는 HTTPS/gRPC 통신, Kafka/NATS 이벤트 처리, DDD/헥사고날 설계를 통해 초저지연과 확장성을 구현합니다. `customer-id`를 중심으로 시작하며, 2027년 v1.0부터 2040년까지 단계적 성장을 지원합니다.